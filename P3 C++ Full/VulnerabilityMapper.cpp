#include "VulnerabilityMapper.h"
#include <iostream>
#include <iomanip>
#include <vector>
using namespace std;

void VulnerabilityMapper::unordered_map_SQL_upload(vector<string> &input_data_vector)
{
//    cve_id_map[input_data_vector.at(0)] = {input_data_vector.at(1), input_data_vector.at(2), input_data_vector.at(3), input_data_vector.at(4), input_data_vector.at(5), input_data_vector.at(6), stof(input_data_vector.at(7))};
    cve_id_map[input_data_vector.at(0)] = {input_data_vector.at(1), input_data_vector.at(2), input_data_vector.at(3), input_data_vector.at(4), input_data_vector.at(5), stof(input_data_vector.at(6))};
}

//appends the values from the id_map into the ordered multi_map, essentially acting as a sorted tree but w/ more nodes as we allow duplicate keys (pushed down tree in order of cvss score)
void VulnerabilityMapper::multimap_add_and_sort()
{
    for (const auto& [key, data] : cve_id_map) {
        cvss_ordered_map.insert({data.cvss, key});
    }
}

//increment through each cvss value in the multimap based off some key_input parameter
void VulnerabilityMapper::multimap_print_by_input(string date_search, string vendor_search, string product_search, string os_search, string sev_search)
{
    int counter = 0;
    for(const auto& [cvss, key] : cvss_ordered_map)
    {
        const DataTable& table_reference = cve_id_map[key];
        if ((date_search.empty() || table_reference.published_date == date_search) &&
            (vendor_search.empty() || table_reference.vendor == vendor_search) &&
            (product_search.empty() || table_reference.product == product_search) &&
            (os_search.empty() || table_reference.os_type == os_search) &&
            (sev_search.empty() || table_reference.severity == sev_search))
        {
            counter++;
            cout << std::left << std::setw(16) << key << " | "
                 << std::left << std::fixed << std::setprecision(1) << std::setw(4) << table_reference.cvss << " | "
                 << std::left  << std::setw(80) << ("vendor: " + table_reference.vendor) << " | "
                 << std::left  << std::setw(85) << ("product: " + table_reference.product) << " | "
                 << std::left  << std::setw(62) << ("os: " + table_reference.os_type) << " | "
                 << std::left  << std::setw(20) << ("severity: " + table_reference.severity) << " | "
                 << std::left << std::setw(10) << table_reference.published_date << " | "
                 << std::endl;
        }
    }
    cout << "total search hits: " << counter << endl;
}
